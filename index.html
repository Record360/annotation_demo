<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Record360 - Image Annotation</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #1a2744;
            min-height: 100vh;
            display: flex;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: #1a2744;
            min-height: 100vh;
            padding: 0;
            flex-shrink: 0;
        }

        .logo {
            padding: 20px 24px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .logo h1 {
            color: white;
            font-size: 18px;
            font-weight: 600;
            letter-spacing: 2px;
        }

        .logo span {
            font-weight: 400;
        }

        .nav-section {
            padding: 16px 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 24px;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            font-weight: 500;
        }

        .nav-item:hover {
            color: white;
            background: rgba(255,255,255,0.05);
        }

        .nav-item.active {
            background: #f05a5b;
            color: white;
        }

        .nav-item svg {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            opacity: 0.8;
        }

        .nav-label {
            padding: 20px 24px 8px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255,255,255,0.4);
            font-weight: 600;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        .header {
            background: white;
            padding: 20px 32px;
            border-bottom: 1px solid #e5e9ef;
        }

        .header h2 {
            font-size: 24px;
            font-weight: 600;
            color: #1a2744;
            margin-bottom: 16px;
        }

        .tabs {
            display: flex;
            gap: 24px;
            align-items: center;
        }

        .tab {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
            font-size: 14px;
            color: #64748b;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab:hover {
            color: #1a2744;
        }

        .tab.active {
            color: #2ecc87;
            border-bottom-color: #2ecc87;
        }

        .tab .count {
            background: #e5e9ef;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .tab.active .count {
            background: #2ecc87;
            color: white;
        }

        /* Toolbar */
        .toolbar {
            background: white;
            padding: 16px 32px;
            border-bottom: 1px solid #e5e9ef;
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            align-items: center;
        }

        .tool-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tool-group-label {
            font-size: 12px;
            color: #64748b;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tool-buttons {
            display: flex;
            background: #f5f7fa;
            border-radius: 8px;
            padding: 4px;
        }

        button {
            padding: 8px 14px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            font-family: inherit;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        button.tool-btn {
            background: transparent;
            color: #64748b;
        }

        button.tool-btn:hover {
            background: #e5e9ef;
            color: #1a2744;
        }

        button.tool-btn.active {
            background: #1a2744;
            color: white;
        }

        button.action-btn {
            background: #2ecc87;
            color: white;
        }

        button.action-btn:hover {
            background: #27b077;
        }

        button.danger-btn {
            background: #f5f7fa;
            color: #f05a5b;
            border: 1px solid #e5e9ef;
        }

        button.danger-btn:hover {
            background: #fef2f2;
            border-color: #f05a5b;
        }

        button.secondary-btn {
            background: #f5f7fa;
            color: #1a2744;
            border: 1px solid #e5e9ef;
        }

        button.secondary-btn:hover {
            background: #e5e9ef;
        }

        input[type="color"] {
            width: 36px;
            height: 36px;
            border: 2px solid #e5e9ef;
            border-radius: 8px;
            cursor: pointer;
            padding: 2px;
        }

        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 2px;
        }

        input[type="color"]::-webkit-color-swatch {
            border-radius: 4px;
            border: none;
        }

        input[type="range"] {
            width: 100px;
            height: 6px;
            -webkit-appearance: none;
            background: #e5e9ef;
            border-radius: 3px;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #1a2744;
            border-radius: 50%;
            cursor: pointer;
        }

        select {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #e5e9ef;
            background: white;
            color: #1a2744;
            font-size: 13px;
            font-family: inherit;
            cursor: pointer;
        }

        select:focus {
            outline: none;
            border-color: #2ecc87;
        }

        .size-value {
            font-size: 12px;
            color: #64748b;
            min-width: 24px;
            text-align: center;
        }

        /* Canvas Area */
        .canvas-wrapper {
            flex: 1;
            padding: 24px 32px;
            overflow: auto;
            background: #f5f7fa;
        }

        .canvas-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            display: inline-block;
        }

        #canvas {
            border-radius: 8px;
            display: block;
        }

        /* Image Selector Panel */
        .image-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .image-panel h3 {
            font-size: 14px;
            font-weight: 600;
            color: #1a2744;
            margin-bottom: 12px;
        }

        .sample-images {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .sample-images img {
            width: 100px;
            height: 70px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .sample-images img:hover {
            border-color: #2ecc87;
            transform: translateY(-2px);
        }

        .sample-images img.selected {
            border-color: #2ecc87;
            box-shadow: 0 0 0 3px rgba(46, 204, 135, 0.2);
        }

        .upload-area {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .upload-area input[type="file"] {
            font-size: 13px;
            color: #64748b;
        }

        .upload-area input[type="file"]::file-selector-button {
            padding: 8px 16px;
            border: 1px solid #e5e9ef;
            border-radius: 6px;
            background: white;
            color: #1a2744;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            margin-right: 12px;
            transition: all 0.2s;
        }

        .upload-area input[type="file"]::file-selector-button:hover {
            background: #f5f7fa;
        }

        /* Status Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: #1a2744;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            display: none;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .toast.success {
            background: #2ecc87;
        }

        /* Icons */
        .icon {
            width: 16px;
            height: 16px;
        }

        /* Divider */
        .divider {
            width: 1px;
            height: 32px;
            background: #e5e9ef;
            margin: 0 8px;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="logo">
            <h1>RECORD<span>360</span></h1>
        </div>
        <nav class="nav-section">
            <div class="nav-item">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                Units
            </div>
            <div class="nav-item active">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                Image Annotation
            </div>
            <div class="nav-item">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                Work Orders
            </div>
            <div class="nav-item">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"></path></svg>
                Reports
            </div>
        </nav>
        <div class="nav-label">Administration</div>
        <nav class="nav-section">
            <div class="nav-item">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                Settings
            </div>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="header">
            <h2>Image Annotation</h2>
            <div class="tabs">
                <div class="tab active">
                    <span>Annotate</span>
                </div>
                <div class="tab">
                    <span>History</span>
                    <span class="count">12</span>
                </div>
            </div>
        </div>

        <div class="toolbar">
            <div class="tool-group">
                <span class="tool-group-label">Tools</span>
                <div class="tool-buttons">
                    <button class="tool-btn" id="selectTool" title="Select/Move">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"></path></svg>
                        Select
                    </button>
                    <button class="tool-btn" id="drawTool" title="Free Draw">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                        Draw
                    </button>
                    <button class="tool-btn" id="circleTool" title="Circle">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" stroke-width="2"></circle></svg>
                        Circle
                    </button>
                    <button class="tool-btn" id="rectTool" title="Rectangle">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" stroke-width="2"></rect></svg>
                        Rectangle
                    </button>
                    <button class="tool-btn" id="arrowTool" title="Arrow">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                        Arrow
                    </button>
                    <button class="tool-btn" id="textTool" title="Add Text">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                        Text
                    </button>
                    <button class="tool-btn" id="highlightTool" title="Highlighter">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
                        Highlight
                    </button>
                </div>
            </div>

            <div class="divider"></div>

            <div class="tool-group">
                <span class="tool-group-label">Color</span>
                <input type="color" id="colorPicker" value="#f05a5b">
            </div>

            <div class="tool-group">
                <span class="tool-group-label">Size</span>
                <input type="range" id="brushSize" min="1" max="50" value="5">
                <span class="size-value" id="brushSizeValue">5</span>
            </div>

            <div class="tool-group">
                <span class="tool-group-label">Fill</span>
                <select id="fillOption">
                    <option value="none">No Fill</option>
                    <option value="solid">Solid</option>
                    <option value="transparent">Transparent</option>
                </select>
            </div>

            <div class="divider"></div>

            <button class="secondary-btn" id="undoBtn">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path></svg>
                Undo
            </button>
            <button class="danger-btn" id="deleteBtn">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                Delete
            </button>
            <button class="danger-btn" id="clearBtn">Clear All</button>

            <div style="flex:1"></div>

            <button class="action-btn" id="saveBtn">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                Save Image
            </button>
        </div>

        <div class="canvas-wrapper">
            <div class="image-panel">
                <h3>Select an Image</h3>
                <div class="sample-images" id="sampleImages"></div>
                <div class="upload-area">
                    <input type="file" id="imageUpload" accept="image/*">
                </div>
            </div>

            <div class="canvas-container">
                <canvas id="canvas"></canvas>
            </div>
        </div>
    </main>

    <div class="toast" id="toast">Image saved successfully</div>

    <script>
        // Sample heavy equipment images
        const sampleImages = [
            { url: 'https://images.unsplash.com/photo-1504307651254-35680f356dfd?w=800', name: 'Excavator' },
            { url: 'https://images.unsplash.com/photo-1581092918056-0c4c3acd3789?w=800', name: 'Bulldozer' },
            { url: 'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=800', name: 'Crane' },
            { url: 'https://images.unsplash.com/photo-1621619856624-42fd193a0661?w=800', name: 'Loader' }
        ];

        let canvas;
        let currentTool = 'select';
        let isDrawing = false;
        let startX, startY;
        let currentShape = null;
        let history = [];
        let backgroundImage = null;

        function initCanvas() {
            canvas = new fabric.Canvas('canvas', {
                width: 900,
                height: 600,
                backgroundColor: '#f5f7fa'
            });

            canvas.on('mouse:down', onMouseDown);
            canvas.on('mouse:move', onMouseMove);
            canvas.on('mouse:up', onMouseUp);
            canvas.on('object:modified', saveState);
            canvas.on('object:added', saveState);
        }

        function loadSampleImages() {
            const container = document.getElementById('sampleImages');
            sampleImages.forEach((img, index) => {
                const imgEl = document.createElement('img');
                imgEl.src = img.url;
                imgEl.alt = img.name;
                imgEl.title = img.name;
                imgEl.onclick = (e) => loadImageToCanvas(img.url, e.target);
                container.appendChild(imgEl);
            });
        }

        function loadImageToCanvas(url, targetEl) {
            fabric.Image.fromURL(url, (img) => {
                const scale = Math.min(
                    canvas.width / img.width,
                    canvas.height / img.height
                ) * 0.95;

                img.scale(scale);
                img.set({
                    left: (canvas.width - img.width * scale) / 2,
                    top: (canvas.height - img.height * scale) / 2,
                    selectable: false,
                    evented: false
                });

                canvas.clear();
                canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));
                backgroundImage = img;
                history = [];

                document.querySelectorAll('.sample-images img').forEach(el => el.classList.remove('selected'));
                if (targetEl) targetEl.classList.add('selected');
            }, { crossOrigin: 'anonymous' });
        }

        document.getElementById('imageUpload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    loadImageToCanvas(event.target.result);
                };
                reader.readAsDataURL(file);
            }
        });

        function setTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tool + 'Tool').classList.add('active');

            if (tool === 'draw' || tool === 'highlight') {
                canvas.isDrawingMode = true;
                canvas.freeDrawingBrush.width = parseInt(document.getElementById('brushSize').value);
                canvas.freeDrawingBrush.color = tool === 'highlight'
                    ? hexToRgba(document.getElementById('colorPicker').value, 0.4)
                    : document.getElementById('colorPicker').value;
            } else {
                canvas.isDrawingMode = false;
            }

            canvas.selection = tool === 'select';
        }

        document.getElementById('selectTool').onclick = () => setTool('select');
        document.getElementById('drawTool').onclick = () => setTool('draw');
        document.getElementById('circleTool').onclick = () => setTool('circle');
        document.getElementById('rectTool').onclick = () => setTool('rect');
        document.getElementById('arrowTool').onclick = () => setTool('arrow');
        document.getElementById('textTool').onclick = () => setTool('text');
        document.getElementById('highlightTool').onclick = () => setTool('highlight');

        function onMouseDown(opt) {
            if (currentTool === 'select' || currentTool === 'draw' || currentTool === 'highlight') return;

            isDrawing = true;
            const pointer = canvas.getPointer(opt.e);
            startX = pointer.x;
            startY = pointer.y;

            const color = document.getElementById('colorPicker').value;
            const strokeWidth = parseInt(document.getElementById('brushSize').value);
            const fillOption = document.getElementById('fillOption').value;

            let fill = 'transparent';
            if (fillOption === 'solid') fill = color;
            else if (fillOption === 'transparent') fill = hexToRgba(color, 0.3);

            if (currentTool === 'circle') {
                currentShape = new fabric.Circle({
                    left: startX,
                    top: startY,
                    radius: 0,
                    stroke: color,
                    strokeWidth: strokeWidth,
                    fill: fill,
                    originX: 'center',
                    originY: 'center'
                });
                canvas.add(currentShape);
            } else if (currentTool === 'rect') {
                currentShape = new fabric.Rect({
                    left: startX,
                    top: startY,
                    width: 0,
                    height: 0,
                    stroke: color,
                    strokeWidth: strokeWidth,
                    fill: fill
                });
                canvas.add(currentShape);
            } else if (currentTool === 'arrow') {
                currentShape = new fabric.Line([startX, startY, startX, startY], {
                    stroke: color,
                    strokeWidth: strokeWidth
                });
                canvas.add(currentShape);
            } else if (currentTool === 'text') {
                const text = prompt('Enter text:');
                if (text) {
                    const textObj = new fabric.IText(text, {
                        left: startX,
                        top: startY,
                        fontSize: 24,
                        fill: color,
                        fontFamily: 'Inter, Arial, sans-serif'
                    });
                    canvas.add(textObj);
                }
                isDrawing = false;
            }
        }

        function onMouseMove(opt) {
            if (!isDrawing || !currentShape) return;

            const pointer = canvas.getPointer(opt.e);

            if (currentTool === 'circle') {
                const radius = Math.sqrt(
                    Math.pow(pointer.x - startX, 2) + Math.pow(pointer.y - startY, 2)
                );
                currentShape.set({ radius: radius });
            } else if (currentTool === 'rect') {
                const width = pointer.x - startX;
                const height = pointer.y - startY;

                currentShape.set({
                    width: Math.abs(width),
                    height: Math.abs(height),
                    left: width < 0 ? pointer.x : startX,
                    top: height < 0 ? pointer.y : startY
                });
            } else if (currentTool === 'arrow') {
                currentShape.set({ x2: pointer.x, y2: pointer.y });

                if (currentShape.arrowhead) {
                    canvas.remove(currentShape.arrowhead);
                }

                const angle = Math.atan2(pointer.y - startY, pointer.x - startX);
                const headLength = 20;

                const arrowhead = new fabric.Triangle({
                    left: pointer.x,
                    top: pointer.y,
                    width: headLength,
                    height: headLength,
                    fill: currentShape.stroke,
                    angle: (angle * 180 / Math.PI) + 90,
                    originX: 'center',
                    originY: 'center'
                });

                currentShape.arrowhead = arrowhead;
                canvas.add(arrowhead);
            }

            canvas.renderAll();
        }

        function onMouseUp(opt) {
            isDrawing = false;

            if (currentShape && currentTool === 'arrow' && currentShape.arrowhead) {
                const group = new fabric.Group([currentShape, currentShape.arrowhead], {
                    left: currentShape.left,
                    top: currentShape.top
                });
                canvas.remove(currentShape);
                canvas.remove(currentShape.arrowhead);
                canvas.add(group);
            }

            currentShape = null;
        }

        document.getElementById('colorPicker').addEventListener('change', (e) => {
            if (canvas.isDrawingMode) {
                canvas.freeDrawingBrush.color = currentTool === 'highlight'
                    ? hexToRgba(e.target.value, 0.4)
                    : e.target.value;
            }
        });

        document.getElementById('brushSize').addEventListener('input', (e) => {
            document.getElementById('brushSizeValue').textContent = e.target.value;
            if (canvas.isDrawingMode) {
                canvas.freeDrawingBrush.width = parseInt(e.target.value);
            }
        });

        document.getElementById('deleteBtn').onclick = () => {
            const active = canvas.getActiveObjects();
            active.forEach(obj => canvas.remove(obj));
            canvas.discardActiveObject();
            canvas.renderAll();
        };

        document.getElementById('clearBtn').onclick = () => {
            canvas.getObjects().forEach(obj => canvas.remove(obj));
            canvas.renderAll();
            history = [];
        };

        function saveState() {
            if (history.length > 20) history.shift();
            history.push(JSON.stringify(canvas.toJSON()));
        }

        document.getElementById('undoBtn').onclick = () => {
            if (history.length > 1) {
                history.pop();
                const previousState = history[history.length - 1];
                canvas.loadFromJSON(previousState, () => {
                    canvas.renderAll();
                });
            }
        };

        document.getElementById('saveBtn').onclick = () => {
            canvas.discardActiveObject();
            canvas.renderAll();

            const dataURL = canvas.toDataURL({
                format: 'png',
                quality: 1,
                multiplier: 1
            });

            const link = document.createElement('a');
            link.download = 'annotated-image-' + Date.now() + '.png';
            link.href = dataURL;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showToast('Image saved successfully');
        };

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 2500);
        }

        function hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Delete' || e.key === 'Backspace') {
                if (document.activeElement.tagName !== 'INPUT') {
                    document.getElementById('deleteBtn').click();
                }
            }
            if (e.ctrlKey || e.metaKey) {
                if (e.key === 'z') {
                    e.preventDefault();
                    document.getElementById('undoBtn').click();
                }
                if (e.key === 's') {
                    e.preventDefault();
                    document.getElementById('saveBtn').click();
                }
            }
        });

        initCanvas();
        loadSampleImages();
        setTool('select');
    </script>
</body>
</html>
